# Azure AI Hosted Agents with `azd`

This sample shows how to provision Azure resources, build container images, and deploy **Azure AI hosted agents** using **Azure Developer CLI (`azd`)**.

Everything (infra, images, and agents) is wired together so that a single `azd up`:

- Creates the Azure AI Foundry project and supporting resources using Bicep
- Builds and pushes agent container images to Azure Container Registry (ACR)
- Creates/updates hosted agents in the Azure AI project based on those images

The glue is implemented via the `postdeploy` hooks in `azure.yaml` and the `scripts/postdeploy.sh` + `src/deploy_agents.py` scripts.

## Prerequisites

- Azure subscription with permissions to create resources
- [Azure Developer CLI (`azd`)](https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd)
- [Azure CLI (`az`)](https://learn.microsoft.com/cli/azure/install-azure-cli) (used by the postdeploy script)
- Docker (for local image builds in ACR)
- Python 3.10+ (for the deployment script and agents)

## Quick Start: Provision + Deploy with `azd up`

1. **Login to Azure:**

   ```bash
   azd auth login
   ```

2. **Initialize the environment (optional but recommended):**

   ```bash
   azd init
   # When prompted, choose a new or existing environment name
   ```

3. **Provision infrastructure and run post-deploy hooks:**

   From the repo root:

   ```bash
   azd up
   ```

   During `azd up` the following happens:

   - Bicep templates in `infra/` are deployed (AI project, ACR, storage, monitoring, etc.).
   - `azd` writes an environment-specific `.env` file into `.azure/<env-name>/.env` with outputs like `AZURE_AI_PROJECT_ENDPOINT`, `AZURE_CONTAINER_REGISTRY_ENDPOINT`, etc.
   - The **postdeploy hooks** defined in `azure.yaml` run automatically (see below).

4. **Verify deployment:**

   After `azd up` completes successfully, you should have:

   - A `.env` file at the repo root populated with connection info and image URLs
   - One or more hosted agents created in your Azure AI project

## How the `postdeploy` Hook Works

The `postdeploy` section in `azure.yaml` looks like this:

```yaml
hooks:
  postdeploy:
    - name: copy-env-file
      description: Copy environment file from azd environment folder
      shell: sh
      run: cp .azure/$AZURE_ENV_NAME/.env ./
    - name: build-and-push-container-images
      description: Build and push container images to ACR
      shell: sh
      run: ./scripts/postdeploy.sh order-agent:./src/agents/order-agent
```

In order, it does:

1. **`copy-env-file`** – Copies the `.env` generated by `azd` for the current environment to the repo root. This makes variables like `AZURE_AI_PROJECT_ENDPOINT` and `AZURE_CONTAINER_REGISTRY_ENDPOINT` available to local tools and scripts.
2. **`build-and-push-container-images`** – Calls `scripts/postdeploy.sh` with one or more `<image-name>:<path>` arguments.

   For each argument, `scripts/postdeploy.sh`:
   - Uses `AZURE_CONTAINER_REGISTRY_ENDPOINT` from the `.env` file to determine which ACR to use
   - Builds and pushes an image to ACR via `az acr build`
   - Writes an environment variable of the form `<IMAGE_NAME>_IMAGE=<full-image-tag>` into the root `.env` file
   - After all images are built, runs `python deploy_agents.py` in `src/`

3. **`src/deploy_agents.py`** – Reads the `.env` file (via `python-dotenv`) and:
   - Discovers all `*_IMAGE` variables (e.g., `ORDER_AGENT_IMAGE`)
   - Derives an agent name from each variable (e.g., `ORDER_AGENT_IMAGE` → `order-agent`)
   - Creates or updates an **image-based hosted agent** in the Azure AI project for each image

Net result: every time you run `azd up` (or `azd deploy` that triggers the postdeploy hooks), your hosted agents are rebuilt and redeployed from source.

## Project Structure (Relevant Parts)

```text
azure.yaml                 # azd configuration + postdeploy hooks
infra/                     # Bicep templates for infra + AI project
scripts/
  postdeploy.sh            # Builds images, pushes to ACR, runs deploy_agents.py
src/
  deploy_agents.py         # Creates/updates hosted agents based on *_IMAGE env vars
  agents/
    order-agent/
      agent.py             # Agent implementation (container entrypoint)
      Dockerfile           # Container definition for the hosted agent
  config/
    settings.py            # Helper for reading config from env
```

## Customizing Agents and Images

- **Add another agent**
  - Create a new folder under `src/agents/<your-agent-name>/` with an `agent.py` and `Dockerfile`.
  - Update the `build-and-push-container-images` hook in `azure.yaml`, passing an additional argument, e.g.:

    ```yaml
    run: ./scripts/postdeploy.sh \
      order-agent:./src/agents/order-agent \
      product-agent:./src/agents/product-agent
    ```

  - Re-run:

    ```bash
    azd up
    # or, after infra exists
    azd deploy
    ```

- **Change model or project endpoint**
  - The script `src/deploy_agents.py` reads `AZURE_AI_PROJECT_ENDPOINT` and `MODEL_DEPLOYMENT_NAME` from the environment (`.env` file).
  - `AZURE_AI_PROJECT_ENDPOINT` is provided by the Bicep deployment and `azd`.
  - You can override `MODEL_DEPLOYMENT_NAME` in the root `.env` if needed.

## Running the Deployment Script Manually (Optional)

If you change only the container images and want to re-register agents without re-running full `azd up`:

1. Ensure your root `.env` is up to date and contains `*_IMAGE` variables.
2. From the repo root, run:

   ```bash
   cd src
   python deploy_agents.py
   ```

This will re-create or update the hosted agents using the already-pushed images.

## Cleanup

To remove all provisioned resources:

```bash
azd down
```

This deletes the resource group created by `azd` (including the AI project, ACR, and other resources).
